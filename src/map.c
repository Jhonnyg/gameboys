#include <gb/gb.h>
#include "map.h"


const unsigned char _bktiles[] = {
	0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15
};

const unsigned char bkgdata[] = {
  0x00,0x00,0x80,0x00,0x00,0x00,0x08,0x00,
  0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,
  0xBF,0x40,0xF6,0x09,0xAF,0x50,0x49,0xF6,
  0xB6,0xBF,0x09,0x09,0x00,0x00,0x00,0x00,
  0x07,0x08,0x0D,0x12,0x0F,0x10,0x07,0x08,
  0x05,0x0A,0x06,0x09,0x0B,0x14,0x05,0x0A,
  0xBF,0x40,0xF7,0x08,0x9F,0x60,0x4D,0xF2,
  0xB7,0xB8,0x0B,0x0C,0x03,0x0C,0x05,0x0A,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xCB,
  0xCB,0x34,0xFE,0x01,0xBF,0x40,0xFB,0x04,
  0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x3C,
  0x18,0x18,0x3C,0x3C,0x66,0x66,0x00,0x00,
  0x03,0x0C,0x05,0x0A,0x03,0x0C,0x07,0x98,
  0x95,0x6A,0xBF,0x40,0xFB,0x04,0xF7,0x08,
  0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x3C,
  0x18,0x18,0x3C,0x3C,0x66,0x66,0x00,0x00,
  0xC8,0x38,0xE8,0x18,0xD0,0x30,0xD0,0x30,
  0x50,0xB0,0xE8,0x18,0xD0,0x30,0xA8,0x58,
  0xEF,0x10,0xBD,0x42,0xFA,0x07,0xF5,0x0D,
  0xA8,0x58,0xE8,0x18,0x50,0xB0,0xC8,0x38,
  0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x3C,
  0x18,0x18,0x3C,0x3C,0x66,0x66,0x00,0x00,
  0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x3C,
  0x18,0x18,0x3C,0x3C,0x66,0x66,0x00,0x00,
  0x68,0x98,0xE8,0x18,0x50,0xB0,0xD0,0x30,
  0xA8,0x58,0x74,0x8F,0xDA,0x25,0xFF,0x00,
  0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x3C,
  0x18,0x18,0x3C,0x3C,0x66,0x66,0x00,0x00,
  0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x3C,
  0x18,0x18,0x3C,0x3C,0x66,0x66,0x00,0x00,
  0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x3C,
  0x18,0x18,0x3C,0x3C,0x66,0x66,0x00,0x00,
  0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x3C,
  0x18,0x18,0x3C,0x3C,0x66,0x66,0x00,0x00
};

const unsigned char _tmpmap[] = {
    0, 0, 0, 0,
    0, 0, 0, 0,
    0, 1, 0, 0,
    0, 0, 0, 0
};

void init_background()
{
    HIDE_BKG;
    set_bkg_data(0, 0x10, bkgdata);
    SHOW_BKG;

    generate_visual_map( _tmpmap );

}

// TODO change position etc so its not 8bit values, since it's probably too small

unsigned char calculate_tile( unsigned char x, unsigned char y, unsigned char _map[MAP_SIZE * MAP_SIZE] )
{
	unsigned char tile = 0;

	if (_map[y * MAP_SIZE + x])
	{
		return 4; // return if "inside of wall"
	}
	
	if (y > 0 && _map[(y-1) * MAP_SIZE + x]) // top
		tile |= 0x1;

	if (x < MAP_SIZE && _map[y * MAP_SIZE + (x+1)]) // right
		tile |= 0x2;

	if (y < MAP_SIZE && _map[(y+1) * MAP_SIZE + x]) // bottom
		tile |= 0x4;

	if (x > 0 && _map[y * MAP_SIZE + (x+1)]) // left
		tile |= 0x8;

	return tile;
}

void generate_visual_map( unsigned char _map[MAP_SIZE * MAP_SIZE] )
{
    unsigned char tile;
    unsigned char x;
    unsigned char y;

    HIDE_BKG;

    // build visible map from "REAAUHLL MAP"
    // TODO fix so that y and x start from the player position (minus the screensize or something?)
    for (y = 0; y < MAP_VISIBLE_SIZE; y++)
    {
    	for (x = 0; x < MAP_VISIBLE_SIZE; x++)
    	{
    		tile = calculate_tile(x,y, _map);
    		set_bkg_tiles(x, y, 1, 1, &_bktiles[tile]);
    	}
    }
    //set_bkg_tiles(0, 0, 16, 1, &_bktiles[0]); // DEBUG view all possible wall-combinations

    SHOW_BKG;

}
